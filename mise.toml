min_version = "2025.10.0"

[settings]
jobs = 1

[tools]
node = "24"
pnpm = "latest"

[env]
TZ = "UTC"
LANG = "C"
LC_ALL = "C"
NODE_ENV = "test"
CI = "1"
MISE_TASK_OUTPUT = "prefix"
OC_SERVER_PORT = "4196"
DB_HOST = "127.0.0.1"
DB_PORT = "54329"
DB_USER = "postgres"
DB_PASSWORD = "postgres"
SYSTEM_DB_NAME = "postgres"
SYS_DB_NAME = "dbos_sys"
APP_DB_NAME = "app_local"
OC_MODE = "replay"
SBX_MODE = "mock"
TEST_SEED = "424242"
SBX_QUEUE_CONCURRENCY = "150"
SBX_QUEUE_WORKER_CONCURRENCY = "10"
SBX_QUEUE_RATE_LIMIT_PER_PERIOD = "10000"
SBX_QUEUE_RATE_LIMIT_PERIOD_SEC = "60"
SBX_QUEUE_PARTITION = "true"

[tasks.default]
depends = ["quick"]

[tasks."fmt:check"]
description = "Formatting gate"
sources = ["**/*.ts", "**/*.json", "**/*.md", "mise.toml", "docker-compose.yml"]
outputs = { auto = true }
run = "pnpm exec prettier --check ."

[tasks."fmt:write"]
description = "Apply formatting"
sources = ["**/*.ts", "**/*.json", "**/*.md", "mise.toml", "docker-compose.yml"]
run = "pnpm exec prettier --write ."

[tasks."lint:ts"]
description = "Static linting"
sources = ["src/**/*.ts", "test/**/*.ts", "scripts/**/*.ts", ".eslintrc.cjs", "tsconfig.json"]
outputs = { auto = true }
run = "pnpm exec eslint . --ext .ts"

[tasks."lint:flake"]
description = "Ban nondeterministic primitives outside wrappers"
sources = ["src/**/*.ts", "scripts/lint-flake.sh"]
outputs = { auto = true }
run = "scripts/lint-flake.sh"

[tasks.lint]
depends = ["lint:ts", "lint:flake", "fe:lint"]

[tasks."fe:lint"]
description = "Next.js lint"
sources = ["app/**/*.ts", "app/**/*.tsx", "src/components/**/*.tsx", "next.config.ts", "package.json"]
outputs = { auto = true }
run = "pnpm exec next lint"

[tasks."fe:build"]
description = "Next.js build"
depends = ["type"]
sources = ["app/**/*.ts", "app/**/*.tsx", "src/components/**/*.tsx", "src/lib/utils.ts", "next.config.ts", "app/globals.css", "package.json", "tsconfig.json"]
outputs = [".next/"]
run = "pnpm exec next build"

[tasks."type:tsc"]
description = "Type checking"
sources = ["src/**/*.ts", "src/**/*.tsx", "app/**/*.ts", "app/**/*.tsx", "test/**/*.ts", "scripts/**/*.ts", "tsconfig.json"]
outputs = { auto = true }
run = "pnpm exec tsc -p tsconfig.json --noEmit"

[tasks.type]
depends = ["type:tsc"]

[tasks."db:up"]
description = "Boot postgres and wait for healthy"
sources = ["docker-compose.yml", "scripts/db/up.sh"]
outputs = { auto = true }
run = "scripts/db/up.sh"

[tasks."db:down"]
description = "Stop postgres"
sources = ["docker-compose.yml", "scripts/db/down.sh"]
run = "scripts/db/down.sh"

[tasks."db:test:create"]
description = "Create ephemeral test database"
sources = ["scripts/db/test-create.sh", "scripts/db/test-db-name.sh"]
outputs = { auto = true }
run = "scripts/db/test-create.sh"

[tasks."db:test:drop"]
description = "Drop ephemeral test database"
sources = ["scripts/db/test-drop.sh", "scripts/db/test-db-name.sh"]
run = "scripts/db/test-drop.sh"

[tasks."db:migrate"]
description = "Apply migrations"
depends = ["db:up"]
sources = ["db/migrations/**/*.sql", "scripts/db/migrate.sh"]
outputs = { auto = true }
run = "scripts/db/migrate.sh"

[tasks."db:seed"]
description = "Apply seed data"
depends = ["db:migrate"]
sources = ["db/seed/**/*.sql", "scripts/db/seed.sh"]
outputs = { auto = true }
run = "scripts/db/seed.sh"

[tasks."db:reset"]
description = "Reset app schema only"
depends = ["db:up"]
run = "if [ \"${MISE_NO_RESET:-0}\" = \"1\" ]; then echo '[db:reset] skipped (MISE_NO_RESET=1)'; else scripts/db/reset.sh; fi"

[tasks."db:sys:reset"]
description = "Reset DBOS system schema"
depends = ["db:up"]
run = "if [ \"${MISE_NO_RESET:-0}\" = \"1\" ]; then echo '[db:sys:reset] skipped (MISE_NO_RESET=1)'; else scripts/db/reset-sysdb.sh; fi"

[tasks."db:sys:inspect"]
description = "Inspect DBOS system tables"
depends = ["db:up"]
sources = ["scripts/db/psql-sys.sh"]
run = "scripts/db/psql-sys.sh -c '\\dt dbos.*'"

[tasks."test:unit"]
description = "Deterministic unit tests"
sources = ["src/**/*.ts", "src/**/*.tsx", "test/setup.ts", "test/unit/**/*.ts", "vitest.config.ts"]
outputs = { auto = true }
run = "TEST_SUITE=unit pnpm exec vitest run test/unit --config vitest.config.ts"

[tasks."test:unit:soak"]
description = "Flake detector"
depends = ["test:unit"]
sources = ["src/**/*.ts", "test/**/*.ts", "scripts/test-unit-soak.sh"]
outputs = { auto = true }
run = "scripts/test-unit-soak.sh"

[tasks."test:integration:mock"]
description = "Offline integration tests using ephemeral DB"
depends = ["db:up"]
env = { PORT = "3103", ADMIN_PORT = "3105" }
sources = ["src/**/*.ts", "test/integration/**/*.ts", "scripts/test-integration-mock.sh", "vitest.config.ts", "db/migrations/**/*.sql", "db/seed/**/*.sql", "dbos-config.yaml"]
outputs = { auto = true }
run = "scripts/test-integration-mock.sh"

[tasks."test:integration:mock:file"]
description = "Targeted integration tests without caching. Usage: mise run test:integration:mock:file <path>"
depends = ["db:up"]
env = { PORT = "3103", ADMIN_PORT = "3105" }
run = "scripts/test-integration-mock.sh {{arg(i=1)}}"

[tasks."test:integration:hitl:c6"]
description = "HITL C6 chaos+golden integration matrix"
depends = ["db:up"]
env = { PORT = "3013", ADMIN_PORT = "3014" }
sources = [
  "src/**/*.ts",
  "test/helpers/hitl-chaos-kit.ts",
  "test/integration/hitl-chaos-golden.test.ts",
  "test/integration/hitl-kill4.test.ts",
  "scripts/test-integration-mock.sh",
  "vitest.config.ts",
  "db/migrations/**/*.sql",
  "db/seed/**/*.sql",
  "dbos-config.yaml"
]
outputs = { auto = true }
run = "scripts/test-integration-mock.sh test/integration/hitl-chaos-golden.test.ts test/integration/hitl-kill4.test.ts"

[tasks."test:e2e"]
description = "End-to-end smoke (full suite)"
depends = ["db:sys:reset", "db:reset"]
env = { PORT = "3007", ADMIN_PORT = "3008" }
run = "OC_SERVER_PORT=4096 scripts/oc-daemon-stop.sh >/dev/null 2>&1 || true; OC_SERVER_PORT=4096 TEST_SUITE=e2e pnpm exec vitest run test/e2e/runs-retry.test.ts test/e2e/api-shim.test.ts test/e2e/plan-approval-api.test.ts test/e2e/run-view-golden.test.ts test/e2e/plan-build-approval.test.ts test/e2e/intents-validation.test.ts test/e2e/http-crashdemo.test.ts test/e2e/oc-daemon-restart-safe.test.ts test/e2e/ops-controls.test.ts --config vitest.config.ts --fileParallelism=false"

[tasks."test:e2e:file"]
description = "End-to-end smoke (single file). Usage: mise run test:e2e:file <path>"
depends = ["db:sys:reset", "db:reset"]
env = { PORT = "3007", ADMIN_PORT = "3008" }
sources = ["src/**/*.ts", "test/e2e/**/*.ts", "vitest.config.ts", "dbos-config.yaml"]
outputs = { auto = true }
run = "OC_SERVER_PORT=4096 scripts/oc-daemon-stop.sh >/dev/null 2>&1 || true; OC_SERVER_PORT=4096 TEST_SUITE=e2e pnpm exec vitest run {{arg(i=1)}} --config vitest.config.ts --fileParallelism=false"

[tasks."wf:crashdemo"]
description = "Crash-resume durability assertion"
depends = ["db:reset", "build"]
env = { PORT = "3004", ADMIN_PORT = "3006" }
sources = ["src/**/*.ts", "scripts/wf-crashdemo.sh", "db/migrations/**/*.sql", "db/seed/**/*.sql", "dbos-config.yaml"]
outputs = { auto = true }
run = "scripts/wf-crashdemo.sh"

[tasks."wf:crashdemo:soak"]
description = "Crash-resume soak"
depends = ["wf:crashdemo"]
sources = ["src/**/*.ts", "scripts/wf-crashdemo-soak.sh", "dbos-config.yaml"]
outputs = { auto = true }
run = "scripts/wf-crashdemo-soak.sh"

[tasks."wf:intent:chaos"]
description = "Intent chaos-resume durability assertion"
depends = ["db:sys:reset", "db:reset", "build"]
env = { PORT = "3011", ADMIN_PORT = "3012" }
sources = ["src/**/*.ts", "scripts/wf-intent-chaos.sh", "scripts/repro-pack.ts", "dbos-config.yaml"]
outputs = { auto = true }
run = "scripts/wf-intent-chaos.sh"

[tasks."wf:intent:chaos:soak"]
description = "Intent chaos forced-rerun soak"
depends = ["wf:intent:chaos"]
sources = ["src/**/*.ts", "scripts/wf-intent-chaos-soak.sh", "dbos-config.yaml"]
outputs = { auto = true }
run = "scripts/wf-intent-chaos-soak.sh"

[tasks."wf:time:sleep"]
description = "Time sleep durability smoke"
depends = ["db:reset", "build"]
env = { PORT = "3015", ADMIN_PORT = "3016" }
sources = ["src/**/*.ts", "scripts/time-sleep-smoke.sh", "dbos-config.yaml"]
run = "scripts/time-sleep-smoke.sh"

[tasks."wf:time:scheduler"]
description = "Time scheduler catch-up smoke"
depends = ["db:reset", "build"]
env = { PORT = "3017", ADMIN_PORT = "3018" }
sources = ["src/**/*.ts", "scripts/time-scheduler-smoke.sh", "dbos-config.yaml"]
run = "scripts/time-scheduler-smoke.sh"

[tasks."otlp:smoke"]
description = "OTLP telemetry wiring smoke"
depends = ["db:reset", "build"]
sources = ["src/**/*.ts", "scripts/otlp-smoke.ts", "scripts/otlp-mock-receiver.ts"]
run = """
pnpm exec tsx scripts/otlp-mock-receiver.ts &
MOCK_PID=$!
sleep 1
OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=http://127.0.0.1:4318 OTEL_EXPORTER_OTLP_LOGS_ENDPOINT=http://127.0.0.1:4318 pnpm exec tsx scripts/otlp-smoke.ts
kill $MOCK_PID || true
"""

[tasks."wf:ui:durability"]
description = "UI-parity durability smoke"
depends = ["db:reset", "build"]
sources = ["src/**/*.ts", "scripts/wf-ui-durability.sh", "scripts/oc-mock-daemon.ts"]
run = "scripts/wf-ui-durability.sh"

[tasks."sandbox:soak"]
description = "Parallel sandbox throughput soak"
depends = ["db:sys:reset", "db:reset", "build"]
sources = ["src/**/*.ts", "scripts/sandbox-parallel-soak.sh"]
outputs = { auto = true }
run = "scripts/sandbox-parallel-soak.sh"

[tasks."sandbox:fanout:soak"]
description = "Fan-out sandbox throughput soak (N=100 + restarts)"
depends = ["db:sys:reset", "db:reset", "build"]
sources = ["src/**/*.ts", "scripts/sandbox-fanout-soak.sh", "scripts/oc-mock-daemon.ts"]
outputs = { auto = true }
run = "scripts/sandbox-fanout-soak.sh"

[tasks."hitl:load:soak"]
description = "HITL 1k-wait and burst-reply soak"
depends = ["db:sys:reset", "db:reset", "build"]
env = { PORT = "3021", ADMIN_PORT = "3022" }
sources = [
  "src/**/*.ts",
  "scripts/hitl-load-soak.sh",
  "scripts/hitl-load-soak.ts",
  "scripts/hitl-load-1k.sh",
  "scripts/hitl-load-1k.ts",
  "scripts/hitl-soak-core.ts",
  "scripts/hitl-soak-stack.sh",
  "scripts/oc-mock-daemon.ts"
]
outputs = { auto = true }
run = "N=40 scripts/hitl-load-soak.sh"

[tasks."hitl:load:1k"]
description = "HITL C7 1k concurrent wait probe"
depends = ["db:sys:reset", "db:reset", "build"]
env = { PORT = "3021", ADMIN_PORT = "3022" }
sources = [
  "src/**/*.ts",
  "scripts/hitl-load-1k.sh",
  "scripts/hitl-load-1k.ts",
  "scripts/hitl-soak-core.ts",
  "scripts/hitl-soak-stack.sh",
  "scripts/oc-mock-daemon.ts"
]
outputs = { auto = true }
run = "N=${HITL_SOAK_WAITS:-1000} scripts/hitl-load-1k.sh"

[tasks."hitl:burst:soak"]
description = "HITL C7 burst reply drain + SQL evidence pack"
depends = ["db:sys:reset", "db:reset", "build"]
env = { PORT = "3021", ADMIN_PORT = "3022" }
sources = [
  "src/**/*.ts",
  "scripts/hitl-burst-reply.sh",
  "scripts/hitl-burst-reply.ts",
  "scripts/hitl-soak-core.ts",
  "scripts/hitl-soak-stack.sh",
  "scripts/oc-mock-daemon.ts"
]
outputs = { auto = true }
run = "N=${HITL_SOAK_WAITS:-1000} scripts/hitl-burst-reply.sh"

[tasks."test:soak:hitl"]
description = "HITL C7 soak tests (load + burst)"
depends = ["db:up"]
env = { PORT = "3021", ADMIN_PORT = "3022" }
sources = [
  "src/**/*.ts",
  "test/setup.ts",
  "test/integration/lifecycle.ts",
  "test/soak/**/*.ts",
  "scripts/hitl-soak-core.ts",
  "scripts/test-integration-mock.sh",
  "vitest.config.ts",
  "db/migrations/**/*.sql",
  "db/seed/**/*.sql",
  "dbos-config.yaml"
]
outputs = { auto = true }
run = "HITL_SOAK_TEST_N=${HITL_SOAK_TEST_N:-120} scripts/test-integration-mock.sh test/soak/hitl-load-1k.test.ts test/soak/hitl-burst-reply.test.ts"

[tasks.build]
description = "Compile backend"
sources = ["src/**/*.ts", "tsconfig.build.json", "tsconfig.json"]
outputs = ["dist/main.js"]
run = "pnpm exec tsc -p tsconfig.build.json"

[tasks.start]
description = "Run the compiled app"
depends = ["build"]
sources = ["dist/main.js", "dbos-config.yaml"]
run = "node dist/main.js"

[tasks."start:worker"]
description = "Run the DBOS worker"
depends = ["build"]
sources = ["dist/worker/main.js", "dbos-config.yaml"]
run = "node dist/worker/main.js"

[tasks."start:api-shim"]
description = "Run the API shim"
depends = ["build"]
sources = ["dist/api-shim/main.js", "dbos-config.yaml"]
run = "node dist/api-shim/main.js"

[tasks.stop]
description = "Stop background worker and shim processes"
sources = ["scripts/stop.sh"]
run = "scripts/stop.sh"

[tasks."test:fe"]
description = "Frontend contract validation"
sources = ["src/contracts/ui/**/*.ts", "test/unit/fe-contracts.test.ts"]
outputs = { auto = true }
run = "pnpm exec vitest run test/unit/fe-contracts.test.ts --config vitest.config.ts"

[tasks.quick]
description = "Fast local gradient"
depends = ["fmt:check", "lint", "type", "test:unit", "test:fe", "policy"]

[tasks."check:integration"]
description = "Internal: integration with isolated port"
depends = ["quick", "test:integration:mock"]

[tasks."check:crashdemo"]
description = "Internal: crashdemo with isolated port"
depends = ["db:reset", "build", "check:integration"]
env = { PORT = "3004", ADMIN_PORT = "3006" }
sources = ["src/**/*.ts", "scripts/wf-crashdemo.sh", "db/migrations/**/*.sql", "db/seed/**/*.sql", "dbos-config.yaml"]
outputs = { auto = true }
run = "scripts/wf-crashdemo.sh"

[tasks.check]
description = "Core correctness + durability"
env = { OTLP_REQUIRED = "1", STRICT_TEARDOWN = "1" }
depends = ["fe:build", "check:crashdemo", "policy:hitl-correctness", "test:integration:hitl:c6", "wf:intent:chaos", "wf:time:sleep", "wf:time:scheduler", "otlp:smoke", "wf:ui:durability", "ops", "oc:daemon:contract", "oc:daemon:stop"]

[tasks."oc:refresh"]
description = "Regenerate OC fixtures"
sources = ["src/oc/**/*.ts", "scripts/oc-refresh.ts"]
outputs = { auto = true }
run = "pnpm exec tsx scripts/oc-refresh.ts"

[tasks."oc:live:smoke"]
description = "Single live OC drift check"
depends = ["build"]
env = { OC_MODE = "live", OC_STRICT_MODE = "1" }
sources = ["src/oc/**/*.ts", "scripts/oc-live-smoke.ts"]
outputs = { auto = true }
run = "OC_MODE=live pnpm exec tsx scripts/oc-live-smoke.ts"

[tasks."oc:daemon:signoff"]
description = "Start real OC daemon (no mock fallback)"
env = { OC_STRICT_MODE = "1" }
run = "scripts/oc-daemon-start.sh"

[tasks."sbx:live:smoke"]
description = "Single live SBX smoke"
sources = ["src/sbx/**/*.ts", "scripts/sbx-live-smoke.ts"]
outputs = { auto = true }
run = "SBX_MODE=live pnpm exec tsx scripts/sbx-live-smoke.ts"

[tasks."sbx:template:build"]
description = "Build or emit deterministic SBX template metadata"
sources = ["sbx/e2b/e2b.Dockerfile", "sbx/e2b/e2b.toml", "scripts/sbx-template-build.ts"]
outputs = [".tmp/sbx-template-build.json"]
run = "pnpm exec tsx scripts/sbx-template-build.ts --out .tmp/sbx-template-build.json"

[tasks.full]
description = "Slow path incl. live smokes"
env = { OTLP_REQUIRED = "1", STRICT_TEARDOWN = "1" }
depends = ["check", "test:e2e", "oc:live:smoke", "sbx:live:smoke"]

[tasks.soaks]
description = "Forced-only soak lane"
depends = [
  "test:unit:soak",
  "wf:crashdemo:soak",
  "wf:intent:chaos:soak",
  "sandbox:soak",
  "test:soak:hitl"
]

[tasks."perf:k6:smoke"]
description = "k6 smoke gate: enqueue/status/queue-depth/artifact-read"
depends = ["db:sys:reset", "db:reset", "build"]
sources = ["perf/k6/*.js", "scripts/perf-k6-*.sh", "scripts/hitl-soak-stack.sh", "src/**/*.ts", "db/migrations/**/*.sql", "db/seed/**/*.sql", "dbos-config.yaml"]
outputs = [".tmp/k6/smoke-summary.json", ".tmp/k6/smoke-metrics.json", ".tmp/k6/smoke.log"]
run = "scripts/perf-k6-smoke.sh"

[tasks."perf:k6:ramp"]
description = "k6 ramp gate: sustained mixed-load assertions"
depends = ["db:sys:reset", "db:reset", "build"]
sources = ["perf/k6/*.js", "scripts/perf-k6-*.sh", "scripts/hitl-soak-stack.sh", "src/**/*.ts", "db/migrations/**/*.sql", "db/seed/**/*.sql", "dbos-config.yaml"]
outputs = [".tmp/k6/ramp-summary.json", ".tmp/k6/ramp-metrics.json", ".tmp/k6/ramp.log"]
run = "scripts/perf-k6-ramp.sh"

[tasks."ci:quick"]
depends = ["check", "perf:k6:smoke"]

[tasks."ci:full"]
depends = ["full", "perf:k6:ramp"]

[tasks."test:golden:refresh"]
description = "Refresh RunView golden snapshots"
depends = ["db:sys:reset", "db:reset", "build"]
env = { PORT = "3007", ADMIN_PORT = "3008" }
sources = ["src/**/*.ts", "test/e2e/run-view-golden.test.ts", "vitest.config.ts"]
outputs = ["test/golden/run-view.json"]
run = "OC_SERVER_PORT=4096 scripts/oc-daemon-stop.sh >/dev/null 2>&1 || true; OC_SERVER_PORT=4096 REFRESH_GOLDEN=1 TEST_SUITE=e2e pnpm exec vitest run test/e2e/run-view-golden.test.ts --config vitest.config.ts --fileParallelism=false"

[tasks."dbos:workflow:list"]
description = "List all workflows"
sources = ["dbos-config.yaml"]
run = "pnpm exec dbos workflow list"

[tasks."dbos:workflow:status"]
description = "Show status of a workflow. Usage: mise run dbos:workflow:status <workflowID>"
sources = ["dbos-config.yaml"]
run = "pnpm exec dbos workflow get"

[tasks."dbos:workflow:steps"]
description = "Show steps of a workflow. Usage: mise run dbos:workflow:steps <workflowID>"
sources = ["dbos-config.yaml"]
run = "pnpm exec dbos workflow steps"

[tasks."dbos:workflow:queue:list"]
description = "List all queued workflows"
sources = ["dbos-config.yaml"]
run = "pnpm exec dbos workflow queue list"

[tasks."policy:assert-valid-density"]
description = "Check Ajv gate density"
sources = ["src/contracts/**/*.ts", "scripts/policy-assert-valid-density.sh"]
run = "scripts/policy-assert-valid-density.sh"

[tasks."policy:no-bundlers"]
description = "Ensure no bundlers are used"
sources = ["src/**/*.ts", "scripts/policy-no-bundlers.sh"]
run = "scripts/policy-no-bundlers.sh"

[tasks."policy:no-dbos-ddl"]
description = "Ensure no app tables in dbos schema"
sources = ["db/**/*.sql", "scripts/policy-no-dbos-ddl.sh"]
run = "scripts/policy-no-dbos-ddl.sh"

[tasks."policy:task-sources"]
description = "Ensure all tasks have sources"
sources = ["mise.toml", "scripts/policy-task-sources.sh"]
run = "scripts/policy-task-sources.sh"

[tasks."policy:wf-purity"]
description = "Enforce workflow purity rules (no IO/nondeterminism)"
sources = ["src/workflow/wf/**/*.ts", "src/eval/**/*.ts", "scripts/policy-wf-purity.sh"]
run = "scripts/policy-wf-purity.sh --self-test && scripts/policy-wf-purity.sh"

[tasks."policy:step-retry"]
description = "Enforce step-level retry allowlist"
sources = ["src/workflow/dbos/intentSteps.ts", "scripts/policy-step-retry.sh"]
run = "scripts/policy-step-retry.sh"

[tasks."policy:shim-blackbox"]
description = "Enforce API shim black-box isolation"
sources = ["src/api-shim/**/*.ts", "scripts/policy-shim-blackbox.sh"]
run = "scripts/policy-shim-blackbox.sh"

[tasks."policy:boundary-gates"]
description = "Enforce cycle closure boundary gates"
sources = [
  "app/**/*.ts",
  "app/**/*.tsx",
  "mise.toml",
  "scripts/policy-boundary-gates.sh",
  "src/contracts/ui/artifact-ref-v1.schema.ts",
  "src/contracts/ui/run-header.schema.ts",
  "src/contracts/ui/step-row.schema.ts",
  "src/oc/timeout-policy.ts",
  "src/server/ui-api.ts",
  "src/workflow/engine-dbos.ts",
  "src/workflow/start-intent.ts",
  "src/workflow/steps/run-intent.steps.ts",
  "test/golden/run-view.json",
  "test/integration/oc-bug-11064.test.ts",
  "test/integration/oc-bug-6396.test.ts",
  "test/integration/oc-bug-8528.test.ts"
]
run = "scripts/policy-boundary-gates.sh --self-test && scripts/policy-boundary-gates.sh"

[tasks."policy:oc-boundary"]
description = "Enforce OC boundary and SDK usage rules"
sources = ["src/**/*.ts", "scripts/policy-oc-boundary.sh"]
run = "scripts/policy-oc-boundary.sh"

[tasks."policy:sbx-boundary"]
description = "Enforce SBX boundary and SDK usage rules"
sources = ["src/**/*.ts", "scripts/policy-sbx-boundary.sh"]
run = "scripts/policy-sbx-boundary.sh"

[tasks."policy:oc-config"]
description = "Check for OC config drift and deprecated modes"
sources = ["opencode.json", "scripts/policy-oc-config.sh"]
run = "scripts/policy-oc-config.sh --self-test && scripts/policy-oc-config.sh"

[tasks."policy:no-parentid"]
description = "Ensure no child sessions are triggered"
sources = ["src/**/*.ts", "scripts/policy-no-parentid.sh"]
run = "scripts/policy-no-parentid.sh"

[tasks."policy:no-placeholder-sha"]
description = "Ban placeholder SHAs in codebase"
sources = ["src/**/*.ts", "test/**/*.ts", "scripts/policy-no-placeholder-sha.sh"]
run = "scripts/policy-no-placeholder-sha.sh"

[tasks."policy:queue-partition-propagation"]
description = "Ensure queuePartitionKey is propagated"
sources = ["src/workflow/dbos/intentWorkflow.ts", "test/integration/queue-partition-fairness.test.ts", "scripts/policy-queue-partition-propagation.sh", "scripts/policy-queue-partition-propagation.ts"]
run = "scripts/policy-queue-partition-propagation.sh --self-test && scripts/policy-queue-partition-propagation.sh"

[tasks."policy:api-no-dbos-launch"]
description = "Ensure API runtime modules never execute DBOS workflows directly"
sources = ["src/server/**/*.ts", "app/api/**/*.ts", "scripts/policy-api-no-dbos-launch.sh", "scripts/policy-api-no-dbos-launch.ts"]
run = "scripts/policy-api-no-dbos-launch.sh --self-test && scripts/policy-api-no-dbos-launch.sh"

[tasks."policy:queue-class-parity"]
description = "Ensure runtime queue classes stay canonical"
sources = ["src/workflow/dbos/queues.ts", "dbos-config.yaml", "scripts/policy-queue-class-parity.sh", "scripts/policy-queue-class-parity.ts"]
run = "scripts/policy-queue-class-parity.sh --self-test && scripts/policy-queue-class-parity.sh"

[tasks."policy:ops-surface"]
description = "Enforce exact-6 ops surface and actor propagation"
sources = ["app/api/ops/wf/**/*.ts", "src/server/ops-api.ts", "scripts/policy-ops-surface.sh"]
run = "scripts/policy-ops-surface.sh"

[tasks."policy:stable-recipe-needs-eval-fixtures"]
description = "Stable promotion requires eval+fixtures coverage"
sources = [
  "src/db/recipeRepo.ts",
  "scripts/policy-stable-recipe-needs-eval-fixtures.sh"
]
run = "scripts/policy-stable-recipe-needs-eval-fixtures.sh --self-test && scripts/policy-stable-recipe-needs-eval-fixtures.sh"

[tasks."policy:hitl-abi"]
description = "Enforce HITL key/topic ABI and dedupe reply contract"
sources = [
  "src/contracts/hitl/**/*.ts",
  "src/lib/hitl-topic.ts",
  "src/workflow/hitl/keys.ts",
  "src/workflow/**/*.ts",
  "app/**/*.ts",
  "test/**/*.ts",
  "scripts/policy-hitl-abi.sh",
  "scripts/policy-hitl-abi.ts"
]
run = "scripts/policy-hitl-abi.sh --self-test && scripts/policy-hitl-abi.sh"

[tasks."policy:hitl-event-abi"]
description = "Enforce HITL Event ABI and key/topic patterns"
sources = [
  "src/contracts/hitl/**/*.ts",
  "src/lib/hitl-topic.ts",
  "src/workflow/hitl/keys.ts",
  "scripts/policy-hitl-event-abi.sh",
  "scripts/policy-hitl-event-abi.ts"
]
run = "scripts/policy-hitl-event-abi.sh --self-test && scripts/policy-hitl-event-abi.sh"

[tasks."policy:hitl-correctness"]
description = "Semantic HITL correctness probes (400+zero writes, dedupe x-once, timeout escalation)"
depends = ["db:up"]
env = { PORT = "3015", ADMIN_PORT = "3016" }
sources = [
  "src/**/*.ts",
  "test/helpers/hitl-chaos-kit.ts",
  "test/integration/hitl-correctness-policy.test.ts",
  "scripts/policy-hitl-correctness.sh",
  "scripts/test-integration-mock.sh",
  "vitest.config.ts",
  "db/migrations/**/*.sql",
  "db/seed/**/*.sql",
  "dbos-config.yaml"
]
outputs = { auto = true }
run = "scripts/policy-hitl-correctness.sh --self-test && scripts/policy-hitl-correctness.sh"

[tasks.policy]
description = "Run all policy checks"
depends = ["policy:assert-valid-density", "policy:no-bundlers", "policy:no-dbos-ddl", "policy:task-sources", "policy:wf-purity", "policy:step-retry", "policy:shim-blackbox", "policy:boundary-gates", "policy:oc-boundary", "policy:sbx-boundary", "policy:oc-doc-diff", "policy:oc-config", "policy:no-parentid", "policy:no-placeholder-sha", "policy:queue-partition-propagation", "policy:api-no-dbos-launch", "policy:queue-class-parity", "policy:ops-surface", "policy:stable-recipe-needs-eval-fixtures", "policy:hitl-abi", "policy:hitl-event-abi"]

[tasks."oc:daemon:up"]
description = "Start OC daemon"
run = "scripts/oc-daemon-start.sh"

[tasks."oc:daemon:health"]
description = "Wait for OC daemon health"
depends = ["oc:daemon:up"]
run = "scripts/oc-daemon-health.sh"

[tasks."oc:daemon:stop"]
description = "Stop OC daemon"
run = "scripts/oc-daemon-stop.sh"

[tasks."oc:doc:snapshot"]
description = "Snapshot OC OpenAPI contract"
depends = ["oc:daemon:health"]
sources = ["scripts/oc-doc-snapshot.sh", "opencode.version"]
outputs = ["docs/contracts/opencode/openapi-*.json"]
run = "scripts/oc-doc-snapshot.sh"

[tasks."oc:agents:snapshot"]
description = "Snapshot OC agents list"
depends = ["oc:daemon:health"]
sources = ["scripts/oc-agents-snapshot.sh"]
outputs = ["docs/contracts/opencode/agents.json"]
run = "scripts/oc-agents-snapshot.sh"

[tasks."policy:oc-doc-diff"]
description = "Check for OC OpenAPI drift"
sources = ["docs/contracts/opencode/*.json", "scripts/policy-oc-doc-diff.sh", "fixtures/policy/oc-doc-diff/*.json"]
run = "scripts/policy-oc-doc-diff.sh --self-test && scripts/policy-oc-doc-diff.sh"

[tasks."oc:daemon:contract"]
description = "Full OC daemon contract verification"
depends = ["oc:daemon:health", "oc:doc:snapshot", "oc:agents:snapshot", "policy:oc-doc-diff"]
run = "OC_BASE_URL=http://127.0.0.1:${OC_SERVER_PORT} pnpm exec vitest run test/external/oc-daemon-external-contract.test.ts test/integration/oc-daemon-contract.test.ts test/e2e/oc-daemon-restart-safe.test.ts --config vitest.config.ts"

[tasks."ops:list-failed"]
description = "List failed workflows (ERROR or MAX_RECOVERY_ATTEMPTS_EXCEEDED)"
sources = ["scripts/ops/list_failed.sh", "scripts/ops/cli.ts", "src/server/ops-api.ts", "src/api-shim/dbos-client.ts"]
run = "scripts/ops/list_failed.sh"

[tasks."ops:cancel-batch"]
description = "Cancel a batch of workflows from stdin"
sources = ["scripts/ops/cancel_batch.sh", "scripts/ops/cli.ts", "src/server/ops-api.ts", "src/api-shim/dbos-client.ts"]
run = "scripts/ops/cancel_batch.sh"

[tasks."ops:resume-batch"]
description = "Resume a batch of workflows from stdin"
sources = ["scripts/ops/resume_batch.sh", "scripts/ops/cli.ts", "src/server/ops-api.ts", "src/api-shim/dbos-client.ts"]
run = "scripts/ops/resume_batch.sh"

[tasks."ops:fork-batch"]
description = "Fork a batch of workflows from stdin. Usage: mise run ops:fork-batch <STEP> [APP_VERSION] < ids.txt"
sources = ["scripts/ops/fork_batch.sh", "scripts/ops/cli.ts", "src/server/ops-api.ts", "src/api-shim/dbos-client.ts"]
run = "scripts/ops/fork_batch.sh"

[tasks."ops:retry-from-step"]
description = "Retry a batch of workflows from an explicit step via fork semantics. Usage: mise run ops:retry-from-step <STEP> [APP_VERSION] < ids.txt"
sources = ["scripts/ops/retry_from_step.sh", "scripts/ops/cli.ts", "src/server/ops-api.ts", "src/api-shim/dbos-client.ts"]
run = "scripts/ops/retry_from_step.sh"

[tasks."ops:views:ensure"]
description = "Ensure ops SQL views exist in SYS DB app schema"
depends = ["db:up"]
sources = ["db/migrations/017_ops_views.sql", "scripts/db/psql-sys.sh"]
run = "ROOT=$(git rev-parse --show-toplevel); cat \"$ROOT/db/migrations/017_ops_views.sql\" | scripts/db/psql-sys.sh -v ON_ERROR_STOP=1"

[tasks."ops:sql:inbox"]
description = "Show recent failures from SQL view"
depends = ["ops:views:ensure"]
sources = ["scripts/db/psql-sys.sh"]
run = "scripts/db/psql-sys.sh -c 'SELECT * FROM app.v_ops_failures_24h LIMIT 20;'"

[tasks."ops:sql:slow"]
description = "Show slow steps from SQL view"
depends = ["ops:views:ensure"]
sources = ["scripts/db/psql-sys.sh"]
run = "scripts/db/psql-sys.sh -c 'SELECT * FROM app.v_ops_slow_steps LIMIT 20;'"

[tasks."ops:sql:queues"]
description = "Show queue depth from SQL view"
depends = ["ops:views:ensure"]
sources = ["scripts/db/psql-sys.sh"]
run = "scripts/db/psql-sys.sh -c 'SELECT * FROM app.v_ops_queue_depth;'"

[tasks."ops:sql:snapshot"]
description = "Export deterministic SQL evidence tuple for one run. Usage: mise run ops:sql:snapshot -- --run <runId|workflowId> [--out file]"
depends = ["db:up"]
sources = ["scripts/repro-pack.ts", "src/db/**/*.ts", "src/lib/hash.ts", "src/config.ts"]
run = "pnpm exec tsx scripts/repro-pack.ts"

[tasks.ops]
description = "Run all ops kit health checks"
depends = ["ops:sql:inbox", "ops:sql:slow", "ops:sql:queues"]
