min_version = "2025.10.0"

[settings]
jobs = 1

[tools]
node = "24"
pnpm = "latest"

[env]
TZ = "UTC"
LANG = "C"
LC_ALL = "C"
NODE_ENV = "test"
CI = "1"
MISE_TASK_OUTPUT = "prefix"
PORT = "3001"
ADMIN_PORT = "3002"
OC_SERVER_PORT = "4196"
DB_HOST = "127.0.0.1"
DB_PORT = "54329"
DB_USER = "postgres"
DB_PASSWORD = "postgres"
SYSTEM_DB_NAME = "postgres"
SYS_DB_NAME = "dbos_sys"
APP_DB_NAME = "app_local"
OC_MODE = "replay"
SBX_MODE = "mock"
TEST_SEED = "424242"
SBX_QUEUE_CONCURRENCY = "50"
SBX_QUEUE_WORKER_CONCURRENCY = "10"
SBX_QUEUE_RATE_LIMIT_PER_PERIOD = "100"
SBX_QUEUE_RATE_LIMIT_PERIOD_SEC = "60"
SBX_QUEUE_PARTITION = "true"

[tasks.default]
depends = ["quick"]

[tasks."fmt:check"]
description = "Formatting gate"
sources = ["**/*.ts", "**/*.json", "**/*.md", "mise.toml", "docker-compose.yml"]
outputs = { auto = true }
run = "pnpm exec prettier --check ."

[tasks."fmt:write"]
description = "Apply formatting"
sources = ["**/*.ts", "**/*.json", "**/*.md", "mise.toml", "docker-compose.yml"]
run = "pnpm exec prettier --write ."

[tasks."lint:ts"]
description = "Static linting"
sources = ["src/**/*.ts", "test/**/*.ts", "scripts/**/*.ts", ".eslintrc.cjs", "tsconfig.json"]
outputs = { auto = true }
run = "pnpm exec eslint . --ext .ts"

[tasks."lint:flake"]
description = "Ban nondeterministic primitives outside wrappers"
sources = ["src/**/*.ts", "scripts/lint-flake.sh"]
outputs = { auto = true }
run = "scripts/lint-flake.sh"

[tasks.lint]
depends = ["lint:ts", "lint:flake"]

[tasks."type:tsc"]
description = "Type checking"
sources = ["src/**/*.ts", "test/**/*.ts", "scripts/**/*.ts", "tsconfig.json"]
outputs = { auto = true }
run = "pnpm exec tsc -p tsconfig.json --noEmit"

[tasks.type]
depends = ["type:tsc"]

[tasks."db:up"]
description = "Boot postgres and wait for healthy"
sources = ["docker-compose.yml", "scripts/db/up.sh"]
outputs = { auto = true }
run = "scripts/db/up.sh"

[tasks."db:down"]
description = "Stop postgres"
sources = ["docker-compose.yml", "scripts/db/down.sh"]
run = "scripts/db/down.sh"

[tasks."db:test:create"]
description = "Create ephemeral test database"
sources = ["scripts/db/test-create.sh", "scripts/db/test-db-name.sh"]
outputs = { auto = true }
run = "scripts/db/test-create.sh"

[tasks."db:test:drop"]
description = "Drop ephemeral test database"
sources = ["scripts/db/test-drop.sh", "scripts/db/test-db-name.sh"]
run = "scripts/db/test-drop.sh"

[tasks."db:migrate"]
description = "Apply migrations"
depends = ["db:up"]
sources = ["db/migrations/**/*.sql", "scripts/db/migrate.sh"]
outputs = { auto = true }
run = "scripts/db/migrate.sh"

[tasks."db:seed"]
description = "Apply seed data"
depends = ["db:migrate"]
sources = ["db/seed/**/*.sql", "scripts/db/seed.sh"]
outputs = { auto = true }
run = "scripts/db/seed.sh"

[tasks."db:reset"]
description = "Reset app schema only"
depends = ["db:up"]
run = "scripts/db/reset.sh"

[tasks."db:sys:reset"]
description = "Reset DBOS system schema"
depends = ["db:up"]
run = "scripts/db/reset-sysdb.sh"

[tasks."db:sys:inspect"]
description = "Inspect DBOS system tables"
depends = ["db:up"]
sources = ["scripts/db/psql-sys.sh"]
run = "scripts/db/psql-sys.sh -c '\\dt dbos.*'"

[tasks."test:unit"]
description = "Deterministic unit tests"
sources = ["src/**/*.ts", "test/setup.ts", "test/unit/**/*.ts", "vitest.config.ts"]
outputs = { auto = true }
run = "TEST_SUITE=unit pnpm exec vitest run test/unit --config vitest.config.ts"

[tasks."test:unit:soak"]
description = "Flake detector"
depends = ["test:unit"]
sources = ["src/**/*.ts", "test/**/*.ts", "scripts/test-unit-soak.sh"]
outputs = { auto = true }
run = "scripts/test-unit-soak.sh"

[tasks."test:integration:mock"]
description = "Offline integration tests using ephemeral DB"
depends = ["db:up"]
env = { PORT = "3003", ADMIN_PORT = "3005" }
sources = ["src/**/*.ts", "test/integration/**/*.ts", "scripts/test-integration-mock.sh", "vitest.config.ts", "db/migrations/**/*.sql", "db/seed/**/*.sql", "dbos-config.yaml"]
outputs = { auto = true }
run = "scripts/test-integration-mock.sh"

[tasks."test:integration:mock:file"]
description = "Targeted integration tests without caching. Usage: mise run test:integration:mock:file <path>"
depends = ["db:up"]
env = { PORT = "3003", ADMIN_PORT = "3005" }
run = "scripts/test-integration-mock.sh {{args}}"

[tasks."test:e2e"]
description = "End-to-end smoke (full suite)"
depends = ["db:reset", "db:sys:reset"]
run = "OC_SERVER_PORT=4096 scripts/oc-daemon-stop.sh >/dev/null 2>&1 || true; TEST_SUITE=e2e pnpm exec vitest run test/e2e --config vitest.config.ts --fileParallelism=false"

[tasks."test:e2e:file"]
description = "End-to-end smoke (single file). Usage: mise run test:e2e:file <path>"
depends = ["db:reset", "db:sys:reset"]
sources = ["src/**/*.ts", "test/e2e/**/*.ts", "vitest.config.ts", "dbos-config.yaml"]
outputs = { auto = true }
run = "OC_SERVER_PORT=4096 scripts/oc-daemon-stop.sh >/dev/null 2>&1 || true; TEST_SUITE=e2e pnpm exec vitest run {{arg(i=1)}} --config vitest.config.ts --fileParallelism=false"

[tasks."wf:crashdemo"]
description = "Crash-resume durability assertion"
depends = ["db:reset", "build"]
env = { PORT = "3004", ADMIN_PORT = "3006" }
sources = ["src/**/*.ts", "scripts/wf-crashdemo.sh", "db/migrations/**/*.sql", "db/seed/**/*.sql", "dbos-config.yaml"]
outputs = { auto = true }
run = "scripts/wf-crashdemo.sh"

[tasks."wf:crashdemo:soak"]
description = "Crash-resume soak"
depends = ["wf:crashdemo"]
sources = ["src/**/*.ts", "scripts/wf-crashdemo-soak.sh", "dbos-config.yaml"]
outputs = { auto = true }
run = "scripts/wf-crashdemo-soak.sh"

[tasks."wf:intent:chaos"]
description = "Intent chaos-resume durability assertion"
depends = ["db:reset", "db:sys:reset", "build"]
env = { PORT = "3011", ADMIN_PORT = "3012" }
sources = ["src/**/*.ts", "scripts/wf-intent-chaos.sh", "dbos-config.yaml"]
outputs = { auto = true }
run = "scripts/wf-intent-chaos.sh"

[tasks."wf:intent:chaos:soak"]
description = "Intent chaos forced-rerun soak"
depends = ["wf:intent:chaos"]
sources = ["src/**/*.ts", "scripts/wf-intent-chaos-soak.sh", "dbos-config.yaml"]
outputs = { auto = true }
run = "scripts/wf-intent-chaos-soak.sh"

[tasks."sandbox:soak"]
description = "Parallel sandbox throughput soak"
depends = ["db:reset", "db:sys:reset", "build"]
sources = ["src/**/*.ts", "scripts/sandbox-parallel-soak.sh"]
outputs = { auto = true }
run = "scripts/sandbox-parallel-soak.sh"

[tasks."sandbox:fanout:soak"]
description = "Fan-out sandbox throughput soak (N=100 + restarts)"
depends = ["db:reset", "db:sys:reset", "build"]
sources = ["src/**/*.ts", "scripts/sandbox-fanout-soak.sh", "scripts/oc-mock-daemon.ts"]
outputs = { auto = true }
run = "scripts/sandbox-fanout-soak.sh"

[tasks.build]
description = "Compile backend"
sources = ["src/**/*.ts", "tsconfig.build.json", "tsconfig.json"]
outputs = ["dist/main.js"]
run = "pnpm exec tsc -p tsconfig.build.json"

[tasks.start]
description = "Run the compiled app"
depends = ["build"]
sources = ["dist/main.js", "dbos-config.yaml"]
run = "node dist/main.js"

[tasks."start:worker"]
description = "Run the DBOS worker"
depends = ["build"]
sources = ["dist/worker/main.js", "dbos-config.yaml"]
run = "node dist/worker/main.js"

[tasks."start:api-shim"]
description = "Run the API shim"
depends = ["build"]
sources = ["dist/api-shim/main.js", "dbos-config.yaml"]
run = "node dist/api-shim/main.js"

[tasks.stop]
description = "Stop background worker and shim processes"
sources = ["scripts/stop.sh"]
run = "scripts/stop.sh"

[tasks.quick]
description = "Fast local gradient"
depends = ["fmt:check", "lint", "type", "test:unit", "policy"]

[tasks."check:integration"]
description = "Internal: integration with isolated port"
depends = ["quick", "test:integration:mock"]

[tasks."check:crashdemo"]
description = "Internal: crashdemo with isolated port"
depends = ["db:reset", "build", "check:integration"]
env = { PORT = "3004", ADMIN_PORT = "3006" }
sources = ["src/**/*.ts", "scripts/wf-crashdemo.sh", "db/migrations/**/*.sql", "db/seed/**/*.sql", "dbos-config.yaml"]
outputs = { auto = true }
run = "scripts/wf-crashdemo.sh"

[tasks.check]
description = "Core correctness + durability"
depends = ["check:crashdemo", "wf:intent:chaos", "oc:daemon:contract", "oc:daemon:stop"]

[tasks."oc:refresh"]
description = "Regenerate OC fixtures"
sources = ["src/oc/**/*.ts", "scripts/oc-refresh.ts"]
outputs = { auto = true }
run = "pnpm exec tsx scripts/oc-refresh.ts"

[tasks."oc:live:smoke"]
description = "Single live OC drift check"
depends = ["build"]
env = { OC_MODE = "live", OC_STRICT_MODE = "1" }
sources = ["src/oc/**/*.ts", "scripts/oc-live-smoke.ts"]
outputs = { auto = true }
run = "OC_MODE=live pnpm exec tsx scripts/oc-live-smoke.ts"

[tasks."oc:daemon:signoff"]
description = "Start real OC daemon (no mock fallback)"
env = { OC_STRICT_MODE = "1" }
run = "scripts/oc-daemon-start.sh"

[tasks."sbx:live:smoke"]
description = "Single live SBX smoke"
sources = ["src/sbx/**/*.ts", "scripts/sbx-live-smoke.ts"]
outputs = { auto = true }
run = "SBX_MODE=live pnpm exec tsx scripts/sbx-live-smoke.ts"

[tasks.full]
description = "Slow path incl. live smokes"
depends = ["check", "test:e2e", "test:unit:soak", "wf:crashdemo:soak", "wf:intent:chaos:soak", "sandbox:soak", "oc:live:smoke", "sbx:live:smoke"]

[tasks."ci:quick"]
depends = ["check"]

[tasks."ci:full"]
depends = ["full"]

[tasks."test:golden:refresh"]
description = "Refresh RunView golden snapshots"
depends = ["db:reset", "build"]
sources = ["src/**/*.ts", "test/e2e/run-view-golden.test.ts", "vitest.config.ts"]
outputs = ["test/golden/run-view.json"]
run = "REFRESH_GOLDEN=1 TEST_SUITE=e2e pnpm exec vitest run test/e2e/run-view-golden.test.ts --config vitest.config.ts --fileParallelism=false"

[tasks."dbos:workflow:list"]
description = "List all workflows"
sources = ["dbos-config.yaml"]
run = "pnpm exec dbos workflow list"

[tasks."dbos:workflow:status"]
description = "Show status of a workflow. Usage: mise run dbos:workflow:status <workflowID>"
sources = ["dbos-config.yaml"]
run = "pnpm exec dbos workflow get"

[tasks."dbos:workflow:steps"]
description = "Show steps of a workflow. Usage: mise run dbos:workflow:steps <workflowID>"
sources = ["dbos-config.yaml"]
run = "pnpm exec dbos workflow steps"

[tasks."dbos:workflow:queue:list"]
description = "List all queued workflows"
sources = ["dbos-config.yaml"]
run = "pnpm exec dbos workflow queue list"

[tasks."policy:assert-valid-density"]
description = "Check Ajv gate density"
sources = ["src/contracts/**/*.ts", "scripts/policy-assert-valid-density.sh"]
run = "scripts/policy-assert-valid-density.sh"

[tasks."policy:no-bundlers"]
description = "Ensure no bundlers are used"
sources = ["src/**/*.ts", "scripts/policy-no-bundlers.sh"]
run = "scripts/policy-no-bundlers.sh"

[tasks."policy:no-dbos-ddl"]
description = "Ensure no app tables in dbos schema"
sources = ["db/**/*.sql", "scripts/policy-no-dbos-ddl.sh"]
run = "scripts/policy-no-dbos-ddl.sh"

[tasks."policy:task-sources"]
description = "Ensure all tasks have sources"
sources = ["mise.toml", "scripts/policy-task-sources.sh"]
run = "scripts/policy-task-sources.sh"

[tasks."policy:wf-purity"]
description = "Enforce workflow purity rules (no IO/nondeterminism)"
sources = ["src/workflow/wf/**/*.ts", "scripts/policy-wf-purity.sh"]
run = "scripts/policy-wf-purity.sh"

[tasks."policy:shim-blackbox"]
description = "Enforce API shim black-box isolation"
sources = ["src/api-shim/**/*.ts", "scripts/policy-shim-blackbox.sh"]
run = "scripts/policy-shim-blackbox.sh"

[tasks."policy:boundary-gates"]
description = "Enforce cycle closure boundary gates"
sources = ["scripts/policy-boundary-gates.sh", "src/workflow/start-intent.ts"]
run = "scripts/policy-boundary-gates.sh"

[tasks."policy:oc-boundary"]
description = "Enforce OC boundary and SDK usage rules"
sources = ["src/**/*.ts", "scripts/policy-oc-boundary.sh"]
run = "scripts/policy-oc-boundary.sh"

[tasks."policy:sbx-boundary"]
description = "Enforce SBX boundary and SDK usage rules"
sources = ["src/**/*.ts", "scripts/policy-sbx-boundary.sh"]
run = "scripts/policy-sbx-boundary.sh"

[tasks."policy:oc-config"]
description = "Check for OC config drift and deprecated modes"
sources = ["opencode.json", "scripts/policy-oc-config.sh"]
run = "scripts/policy-oc-config.sh --self-test && scripts/policy-oc-config.sh"

[tasks."policy:no-parentid"]
description = "Ensure no child sessions are triggered"
sources = ["src/**/*.ts", "scripts/policy-no-parentid.sh"]
run = "scripts/policy-no-parentid.sh"

[tasks."policy:no-placeholder-sha"]
description = "Ban placeholder SHAs in codebase"
sources = ["src/**/*.ts", "test/**/*.ts", "scripts/policy-no-placeholder-sha.sh"]
run = "scripts/policy-no-placeholder-sha.sh"

[tasks."policy:queue-partition-propagation"]
description = "Ensure queuePartitionKey is propagated"
sources = ["src/workflow/dbos/intentWorkflow.ts", "scripts/policy-queue-partition-propagation.sh"]
run = "scripts/policy-queue-partition-propagation.sh"

[tasks.policy]
description = "Run all policy checks"
depends = ["policy:assert-valid-density", "policy:no-bundlers", "policy:no-dbos-ddl", "policy:task-sources", "policy:wf-purity", "policy:shim-blackbox", "policy:boundary-gates", "policy:oc-boundary", "policy:sbx-boundary", "policy:oc-doc-diff", "policy:oc-config", "policy:no-parentid", "policy:no-placeholder-sha", "policy:queue-partition-propagation"]

[tasks."oc:daemon:up"]
description = "Start OC daemon"
run = "scripts/oc-daemon-start.sh"

[tasks."oc:daemon:health"]
description = "Wait for OC daemon health"
depends = ["oc:daemon:up"]
run = "scripts/oc-daemon-health.sh"

[tasks."oc:daemon:stop"]
description = "Stop OC daemon"
run = "scripts/oc-daemon-stop.sh"

[tasks."oc:doc:snapshot"]
description = "Snapshot OC OpenAPI contract"
depends = ["oc:daemon:health"]
sources = ["scripts/oc-doc-snapshot.sh", "opencode.version"]
outputs = ["docs/contracts/opencode/openapi-*.json"]
run = "scripts/oc-doc-snapshot.sh"

[tasks."oc:agents:snapshot"]
description = "Snapshot OC agents list"
depends = ["oc:daemon:health"]
sources = ["scripts/oc-agents-snapshot.sh"]
outputs = ["docs/contracts/opencode/agents.json"]
run = "scripts/oc-agents-snapshot.sh"

[tasks."policy:oc-doc-diff"]
description = "Check for OC OpenAPI drift"
sources = ["docs/contracts/opencode/*.json", "scripts/policy-oc-doc-diff.sh", "fixtures/policy/oc-doc-diff/*.json"]
run = "scripts/policy-oc-doc-diff.sh --self-test && scripts/policy-oc-doc-diff.sh"

[tasks."oc:daemon:contract"]
description = "Full OC daemon contract verification"
depends = ["oc:daemon:health", "oc:doc:snapshot", "oc:agents:snapshot", "policy:oc-doc-diff"]
run = "OC_BASE_URL=http://127.0.0.1:${OC_SERVER_PORT} pnpm exec vitest run test/external/oc-daemon-external-contract.test.ts test/integration/oc-daemon-contract.test.ts test/e2e/oc-daemon-restart-safe.test.ts --config vitest.config.ts"
