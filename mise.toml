min_version = "2025.10.0"

[tools]
node = "24"
pnpm = "latest"

[env]
TZ = "UTC"
LANG = "C"
LC_ALL = "C"
NODE_ENV = "test"
CI = "1"
MISE_TASK_OUTPUT = "prefix"
PORT = "3001"
ADMIN_PORT = "3002"
DB_HOST = "127.0.0.1"
DB_PORT = "54329"
DB_USER = "postgres"
DB_PASSWORD = "postgres"
SYSTEM_DB_NAME = "postgres"
SYS_DB_NAME = "dbos_sys"
APP_DB_NAME = "app_local"
OC_MODE = "replay"
SBX_MODE = "mock"
TEST_SEED = "424242"

[tasks.default]
depends = ["quick"]

[tasks."fmt:check"]
description = "Formatting gate"
sources = ["**/*.ts", "**/*.json", "**/*.md", "mise.toml", "docker-compose.yml"]
outputs = { auto = true }
run = "pnpm exec prettier --check ."

[tasks."fmt:write"]
description = "Apply formatting"
sources = ["**/*.ts", "**/*.json", "**/*.md", "mise.toml", "docker-compose.yml"]
run = "pnpm exec prettier --write ."

[tasks."lint:ts"]
description = "Static linting"
sources = ["src/**/*.ts", "test/**/*.ts", "scripts/**/*.ts", ".eslintrc.cjs", "tsconfig.json"]
outputs = { auto = true }
run = "pnpm exec eslint . --ext .ts"

[tasks."lint:flake"]
description = "Ban nondeterministic primitives outside wrappers"
sources = ["src/**/*.ts", "scripts/lint-flake.sh"]
outputs = { auto = true }
run = "scripts/lint-flake.sh"

[tasks.lint]
depends = ["lint:ts", "lint:flake"]

[tasks."type:tsc"]
description = "Type checking"
sources = ["src/**/*.ts", "test/**/*.ts", "scripts/**/*.ts", "tsconfig.json"]
outputs = { auto = true }
run = "pnpm exec tsc -p tsconfig.json --noEmit"

[tasks.type]
depends = ["type:tsc"]

[tasks."db:up"]
description = "Boot postgres and wait for healthy"
sources = ["docker-compose.yml", "scripts/db/up.sh"]
outputs = { auto = true }
run = "scripts/db/up.sh"

[tasks."db:down"]
description = "Stop postgres"
sources = ["docker-compose.yml", "scripts/db/down.sh"]
run = "scripts/db/down.sh"

[tasks."db:test:create"]
description = "Create ephemeral test database"
sources = ["scripts/db/test-create.sh", "scripts/db/test-db-name.sh"]
outputs = { auto = true }
run = "scripts/db/test-create.sh"

[tasks."db:test:drop"]
description = "Drop ephemeral test database"
sources = ["scripts/db/test-drop.sh", "scripts/db/test-db-name.sh"]
run = "scripts/db/test-drop.sh"

[tasks."db:migrate"]
description = "Apply migrations"
depends = ["db:up"]
sources = ["db/migrations/**/*.sql", "scripts/db/migrate.sh"]
outputs = { auto = true }
run = "scripts/db/migrate.sh"

[tasks."db:seed"]
description = "Apply seed data"
depends = ["db:migrate"]
sources = ["db/seed/**/*.sql", "scripts/db/seed.sh"]
outputs = { auto = true }
run = "scripts/db/seed.sh"

[tasks."db:reset"]
description = "Reset app schema only"
depends = ["db:up"]
run = "scripts/db/reset.sh"

[tasks."db:sys:reset"]
description = "Reset DBOS system schema"
depends = ["db:up"]
run = "scripts/db/reset-sysdb.sh"

[tasks."db:sys:inspect"]
description = "Inspect DBOS system tables"
depends = ["db:up"]
sources = ["scripts/db/psql-sys.sh"]
run = "scripts/db/psql-sys.sh -c '\\dt dbos.*'"

[tasks."test:unit"]
description = "Deterministic unit tests"
sources = ["src/**/*.ts", "test/setup.ts", "test/unit/**/*.ts", "vitest.config.ts"]
outputs = { auto = true }
run = "TEST_SUITE=unit pnpm exec vitest run test/unit --config vitest.config.ts"

[tasks."test:unit:soak"]
description = "Flake detector"
depends = ["test:unit"]
sources = ["src/**/*.ts", "test/**/*.ts", "scripts/test-unit-soak.sh"]
outputs = { auto = true }
run = "scripts/test-unit-soak.sh"

[tasks."test:integration:mock"]
description = "Offline integration tests using ephemeral DB"
depends = ["db:up"]
env = { PORT = "3003", ADMIN_PORT = "3005" }
run = "scripts/test-integration-mock.sh"

[tasks."test:e2e"]
description = "End-to-end smoke"
depends = ["db:reset"]
run = "TEST_SUITE=e2e pnpm exec vitest run test/e2e --config vitest.config.ts --fileParallelism=false"

[tasks."wf:crashdemo"]
description = "Crash-resume durability assertion"
depends = ["db:reset", "build"]
sources = ["src/**/*.ts", "scripts/wf-crashdemo.sh", "db/migrations/**/*.sql", "db/seed/**/*.sql"]
outputs = { auto = true }
run = "scripts/wf-crashdemo.sh"

[tasks."wf:crashdemo:soak"]
description = "Crash-resume soak"
depends = ["wf:crashdemo"]
sources = ["src/**/*.ts", "scripts/wf-crashdemo-soak.sh"]
outputs = { auto = true }
run = "scripts/wf-crashdemo-soak.sh"

[tasks.build]
description = "Compile backend"
sources = ["src/**/*.ts", "tsconfig.build.json", "tsconfig.json"]
outputs = ["dist/main.js"]
run = "pnpm exec tsc -p tsconfig.build.json"

[tasks.start]
description = "Run the compiled app"
depends = ["build"]
sources = ["dist/main.js"]
run = "node dist/main.js"

[tasks.quick]
description = "Fast local gradient"
depends = ["fmt:check", "lint", "type", "test:unit", "policy"]

[tasks."check:integration"]
description = "Internal: integration with isolated port"
depends = ["db:up", "quick"]
env = { PORT = "3003", ADMIN_PORT = "3005" }
run = "scripts/test-integration-mock.sh"

[tasks."check:crashdemo"]
description = "Internal: crashdemo with isolated port"
depends = ["db:reset", "build", "check:integration"]
env = { PORT = "3004", ADMIN_PORT = "3006" }
run = "scripts/wf-crashdemo.sh"

[tasks.check]
description = "Core correctness + durability"
depends = ["check:crashdemo"]

[tasks."oc:refresh"]
description = "Regenerate OC fixtures"
sources = ["src/oc/**/*.ts", "scripts/oc-refresh.ts"]
outputs = { auto = true }
run = "pnpm exec tsx scripts/oc-refresh.ts"

[tasks."oc:live:smoke"]
description = "Single live OC drift check"
depends = ["build"]
sources = ["src/oc/**/*.ts", "scripts/oc-live-smoke.ts"]
outputs = { auto = true }
run = "OC_MODE=live pnpm exec tsx scripts/oc-live-smoke.ts"

[tasks."sbx:live:smoke"]
description = "Single live SBX smoke"
sources = ["src/sbx/**/*.ts", "scripts/sbx-live-smoke.ts"]
outputs = { auto = true }
run = "SBX_MODE=live pnpm exec tsx scripts/sbx-live-smoke.ts"

[tasks.full]
description = "Slow path incl. live smokes"
depends = ["check", "test:e2e", "test:unit:soak", "wf:crashdemo:soak", "oc:live:smoke", "sbx:live:smoke"]

[tasks."ci:quick"]
depends = ["check"]

[tasks."ci:full"]
depends = ["full"]

[tasks."test:golden:refresh"]
description = "Refresh RunView golden snapshots"
depends = ["db:reset", "build"]
sources = ["src/**/*.ts", "test/e2e/run-view-golden.test.ts", "vitest.config.ts"]
outputs = ["test/golden/run-view.json"]
run = "REFRESH_GOLDEN=1 TEST_SUITE=e2e pnpm exec vitest run test/e2e/run-view-golden.test.ts --config vitest.config.ts --fileParallelism=false"

[tasks."dbos:workflow:list"]
description = "List all workflows"
sources = ["dbos-config.yaml"]
run = "pnpm exec dbos workflow list"

[tasks."dbos:workflow:status"]
description = "Show status of a workflow. Usage: mise run dbos:workflow:status <workflowID>"
sources = ["dbos-config.yaml"]
run = "pnpm exec dbos workflow get"

[tasks."policy:assert-valid-density"]
description = "Check Ajv gate density"
run = "scripts/policy-assert-valid-density.sh"

[tasks."policy:no-bundlers"]
description = "Ensure no bundlers are used"
run = "scripts/policy-no-bundlers.sh"

[tasks."policy:no-dbos-ddl"]
description = "Ensure no app tables in dbos schema"
run = "scripts/policy-no-dbos-ddl.sh"

[tasks."policy:task-sources"]
description = "Ensure all tasks have sources"
run = "scripts/policy-task-sources.sh"

[tasks."policy:wf-purity"]
description = "Enforce workflow purity rules (no IO/nondeterminism)"
sources = ["src/workflow/wf/**/*.ts", "scripts/policy-wf-purity.sh"]
run = "scripts/policy-wf-purity.sh"

[tasks.policy]
description = "Run all policy checks"
depends = ["policy:assert-valid-density", "policy:no-bundlers", "policy:no-dbos-ddl", "policy:task-sources", "policy:wf-purity"]
